---
layout: "post"
title: "2021 毕昇杯回顾"
subtitle: "新北区地下黑心企业"
author: "roife"
date: 2021-08-21

tags: ["比赛@Tags@Tags", "编译原理@Tags@Tags", "毕昇杯@Tags@Tags", "随想@Tags@Tags"]
lang: zh
catalog: true
header-image: ""
header-style: text
---

> 感谢三个靠谱的队友带飞，最后顺利拿下第二名

# 缘起：因巧合参赛

一开始只是导员在群里发了毕昇杯的参赛通知，因为咱一直对编译很有兴趣，所以想着虽然还没正式上《编译原理》这门课，但能不能参加个比赛凑凑热闹（顺便当作预习课程）。由于通知说这个比赛必须组团参加（其实后面发现并不需要），于是在一些地方想找点队友，但是过了几天也没有人回应。

当我快放弃参加这个比赛的时候，突然 AI（@GeneraluseAI）和 zgg（@Codevka）找上来一起组队，他们两个人拉上大三的 6 系龙芯爷 cgg（@dglr）还差一个人，正好 ~~JB 群友一家亲~~，于是一起组成了一只四人的参赛队伍。

到后来回顾的时候，才发现一切的起因是由无数巧合所拼凑而成的，或许导员没在 19 级群里发通知，又或者 AI 找到了队友，后面的一切都有可能不再发生了。

# 前期：调研，分工与期末考试

## 调研与放弃：多面体模型

前期大家都没啥经验，只知道中科大整了一个并行化。那个时候我们都还没有去看中科大的实现方法（后面知道了，觉得太脏了），想着搞出一个“大的”，于是把目光放向了多面体模型。当时并不知道这玩意儿的难度，所以画了几周时间去读这个方面的 paper。在这个阶段我们还是一个星期见面分享一次，讲讲自己过去一周干的活（实际上几乎都没什么进展）。

当时发现多面体模型需要一个数值运算的库，而 Java 没有这个库，因此想着能不能通过 wrapper 等手法把它搞上去，但是这个手段被比赛禁止了。直到后面和老师一起开会的时候把多面体这条路给否决了，我们也才放弃这个方向。后面看来只能说还好我们放弃了这条路，因为后面发现这玩意儿性价比太低了，并且做完基础优化也需要我们大量的时间。

后来的分工则是因为只有 6 系学了体系架构相关的东西，所以我和 cgg 负责后端；AI 和 zgg 负责前端。

## 分工与准备：CI/Docker/LLVM MCA/perf

在准备的中途我们正好完成了分工，因为我没有编译的经验，所以先去做 CI 相关的东西。但是即便和编译的内容无关，我还是花了很多功夫去学 CI 的用法。

中间又花了很多时间在调研性能测试方法上，学了 LLVM MCA 和 perf 的用法，并且发现 perf 不能在树莓派的 Raspberry PI OS 上正常运行，又花了很多工夫去折腾。（然后直到比赛结束我们几乎没怎么真正地用过这两个玩意儿……）

## 期末考试

期末考试前去和杰哥整了一个航概 App 花了大量的时间，然后又在调研上花了很多时间，直接导致没时间复习，结果这次期末考试翻车了。

永远不要对自己过于自信……

# 初赛：寄存器分配的地狱

开始进入比赛状态的那几天我们恰好刚结束期末考试，正好几门期末考试成绩下来把我心态干崩了，所以 paper 不怎么看得下去。中途大家还有小学期之类的破事，所以一开始的效率很低，大概是到了七月十几号才慢慢进入了状态。中途找教室也花了我们很多时间，最后在地下找到了一个闷热的空教室 996。

一开始我们打算用线性扫描做寄存器，同时看了两三天 LLVM 寄存器分配相关的东西，得出的结论就是：放弃。一方面是因为 LLVM 的线扫大复杂了，看起来很麻烦，另一方面也是因为不成熟的线扫效率上比图着色差很多。所以我们最后选择了图着色做我们的分配算法。恰好虎书上有这方面的内容，于是我就去做图着色了。其实这是一个很不明智的决定，因为图着色算法调试起来非常痛苦，正确的做法是先写一个 trivial 的分配方案用来调 codegen 的 bug，保证 codegen 没问题以后再去写图着色。事实上我调试寄存器分配时大部分 bug 确实是 codegen 的问题。

## 插曲：中科大的并行化

一个字：脏。

我认为第一届中科大的做法几乎等同于**作弊**了，经过讨论我们也放弃了中科大那种“对拍”的做法，这导致我们后面把并行化的优先级下调。

## 插曲：第一次通过功能点

今年的初赛样例新增了很多，而且都比较难。所以初赛就是不停地调 bug，写 pass。正当我们以为初赛出现都困难的时候，终于调通了功能点。但是比较出乎意料的是居然一下子到了榜一。这一下子给我们队打了一针强心剂，让我们继续有了动力前进。

# 从初赛到决赛

不停地调 bug，写 pass。或许是因为通过功能点时的成绩太领先了，中间有几天有点飘……不过后面还好及时调整了过来，事实证明对手是十分强劲的，一不小心就会被干烂 QAQ。

其实比赛越到后面心态就有可能越多，因为有很多优化可能都是负优化，做了效果反而会变差，这个时候就会感觉到非常虚无。还好大家都度过了这个阶段。

# 决赛：通宵的两天

决赛样例一出来的时候把我们队整麻了，因为我们在隐藏点上表现非常不理想（拉垮）。还好中间 zgg 整出了指令融合那个点，让我们一下子有了信心。

决赛我身上基本没什么任务，所以就是不停地帮忙提交。但是这次的评测机经常翻车，这一点要狠狠地批评举办方，真的太拉垮了，导致我们基本没怎么调出来 bug。决赛还花了一晚上做出了并行（感谢 @DDoSolitary 外援），结果因为评测机频繁崩溃我们没时间调试而放弃不用，不然有可能就第一了 emmmm。

中途湖南大学和华南理工都非常强势，分数每次提交都高一点，着实把我们吓倒了。

# 感想

这是我迄今为止度过的最好的暑假。

# 经验

- 线下开发好，面对面效率更高
- 先做基础优化（包括普通优化和并行化等），然后根据公开样例寻找可以优化的点
- 后端指令选择和窥孔可以生成代码后和 LLVM 对比，看看自己生成的代码有什么问题
- 一定要做一个高层的 IR 方便语言级的变换，到了中层只有基本块的时候，很多语义信息都丢失了
- 后端可以考虑做一个数据流分析，这样窥孔能做的事情也更多了